{
  "version": 3,
  "sources": ["../../../../sim/cobblemon/cobbled-debug-server.ts"],
  "sourcesContent": ["import {BattleStream} from \"../battle-stream\";\r\nimport {Dex, toID} from \"../dex\";\r\nimport * as Net from \"net\";\r\nimport {Cobblemon} from \"./cobblemon\";\r\n\r\n/*-----------------------------------------------------------------------------------------------------------------\r\nNOTE: The functions in this file are used by SocketShowdownService, the debug/remote Showdown environment. For the\r\ncorresponding GraalShowdownService methods, see cobbled-index.js in this repo.\r\nSee ShowdownService.kt for where the interface is defined and configured on the main Cobblemon repo.\r\n-----------------------------------------------------------------------------------------------------------------*/\r\n\r\nexport function startServer(port: number): void {\r\n\tconst server = Net.createServer();\r\n\tconst battleMap = new Map<string, BattleStream>();\r\n\r\n\tserver.listen(port, () => {\r\n\t\tconsole.log('Server listening for connection requests on socket localhost: ' + port);\r\n\t});\r\n\r\n\tserver.on('connection', socket => onConnection(socket, battleMap));\r\n}\r\n\r\nfunction onData(socket: Net.Socket, chunk: Buffer, battleMap: Map<string, BattleStream>) {\r\n\tconst data = chunk.toString();\r\n\tconst lines = data.split('\\n');\r\n\r\n\tlines.forEach(line => {\r\n\t\tconsole.log('Data received from client: ' + line);\r\n\t\tconst parts = line.split(' ');\r\n\t\tconst command = parts[0];\r\n\r\n\t\tswitch (command) {\r\n\t\t\tcase '>startbattle': {\r\n\t\t\t\tconst battleId = parts[1];\r\n\t\t\t\tif (battleId) {\r\n\t\t\t\t\tbattleMap.set(battleId, new BattleStream());\r\n\t\t\t\t\tsocket.write('ACK');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"Command '>startbattle' requires a battleId.\");\r\n\t\t\t\t\tsocket.write('ERR');\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>receiveData': {\r\n\t\t\t\tconst type = parts[1];\r\n\t\t\t\tconst registry = Cobblemon.getRegistry(type);\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (!registry) throw new Error();\r\n\r\n\t\t\t\t\tconst data = line.substring(command.length + type.length + 2);\r\n\t\t\t\t\tconst obj = () => {\r\n\t\t\t\t\t\ttry { return JSON.parse(data); }\r\n\t\t\t\t\t\tcatch { return eval(`(${data})`); }\r\n\t\t\t\t\t};\r\n\t\t\t\t\tfor (const [key, value] of Object.entries(obj())) {\r\n\t\t\t\t\t\tregistry.register(value as any, toID(key));\r\n\t\t\t\t\t};\r\n\t\t\t\t\tregistry.invalidate();\r\n\r\n\t\t\t\t\tsocket.write('ACK');\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(`Error processing >receiveData for type ${type}:`, e);\r\n\t\t\t\t\tsocket.write('ERR');\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>receiveEntry': {\r\n\t\t\t\tconst type = parts[1];\r\n\t\t\t\tconst registry = Cobblemon.getRegistry(type);\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (!registry) throw new Error();\r\n\r\n\t\t\t\t\tconst id = parts[2];\r\n\t\t\t\t\tconst data = line.substring(command.length + type.length + id.length + 2);\r\n\t\t\t\t\tconst obj = () => {\r\n\t\t\t\t\t\ttry { return JSON.parse(data); }\r\n\t\t\t\t\t\tcatch { return eval(`(${data})`); }\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconsole.log(\"entry received: \" + id);\r\n\t\t\t\t\tregistry.register(obj(), toID(id));\r\n\t\t\t\t\tregistry.invalidate();\r\n\r\n\t\t\t\t\tsocket.write('ACK');\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(`Error processing >receiveData for type ${type}:`, e);\r\n\t\t\t\t\tsocket.write('ERR');\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>getData': {\r\n\t\t\t\tconst type = parts[1];\r\n\t\t\t\tvar registry = Cobblemon.getRegistry(type);\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (!registry) throw new Error();\r\n\r\n\t\t\t\t\tconst payload = JSON.stringify(registry.all());\r\n\t\t\t\t\tsocket.write(padNumber(payload.length, 8) + payload);\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(`Error processing >receiveData for type ${type}:`, e);\r\n\t\t\t\t\tsocket.write('ERR');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>resetAll': {\r\n\t\t\t\tfor (const key of Cobblemon.registryKeys) {\r\n\t\t\t\t\tCobblemon.registries[key].reset();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcase '>resetData': {\r\n\t\t\t\tconst type = parts[1];\r\n\t\t\t\tvar registry = Cobblemon.getRegistry(type);\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (!registry) throw new Error();\r\n\r\n\t\t\t\t\tregistry.reset();\r\n\t\t\t\t\tsocket.write('ACK');\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(`Invalid registry type for >getData: ${type}`);\r\n\t\t\t\t\tsocket.write('ERR');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>getTypeChart': {\r\n\t\t\t\tconst payload = JSON.stringify(Dex.data.TypeChart);\r\n\t\t\t\tsocket.write(padNumber(payload.length, 8) + payload);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase '>afterSpeciesInit': {\r\n\t\t\t\tDex.modsLoaded = false;\r\n\t\t\t\tDex.includeMods();\r\n\t\t\t\tsocket.write('ACK');\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tdefault: {\r\n\t\t\t\tconst [battleId, showdownMsg] = line.split('~');\r\n\t\t\t\tconst battleStream = battleMap.get(battleId);\r\n\r\n\t\t\t\tif (battleStream) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\tvoid battleStream.write(showdownMsg);\r\n\t\t\t\t\t} catch (err: any) {\r\n\t\t\t\t\t\tconsole.error(err.stack);\r\n\t\t\t\t\t}\r\n\t\t\t\t\twriteBattleOutput(socket, battleStream);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction writeBattleOutput(socket: Net.Socket, battleStream: BattleStream) {\r\n\tconst messages = battleStream.buf;\r\n\tif (messages.length !== 0) {\r\n\t\tsocket.write(padNumber(messages.length, 8));\r\n\t\tfor (const message of messages) {\r\n\t\t\tsocket.write(padNumber(message.length, 8) + message);\r\n\t\t}\r\n\t} else {\r\n\t\twriteVoid(socket);\r\n\t}\r\n\tbattleStream.buf = [];\r\n}\r\n\r\nfunction writeVoid(socket: Net.Socket) {\r\n\tsocket.write('00000000');\r\n}\r\n\r\nfunction onConnection(socket: Net.Socket, battleMap: Map<string, BattleStream>) {\r\n\tsocket.on('data', (chunk) => {\r\n\t\ttry {\r\n\t\t\tonData(socket, chunk, battleMap);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(error);\r\n\t\t}\r\n\t});\r\n\tsocket.on('end', () => console.log('Closing connection with the client'));\r\n\tsocket.on('error', (err) => console.error(err.stack));\r\n}\r\n\r\nfunction padNumber(num: number, size: number): string {\r\n\tlet numStr = num.toString();\r\n\twhile (numStr.length < size) numStr = \"0\" + numStr;\r\n\treturn numStr;\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": ["battleMap", "socket", "type", "chunk"]
}
